import React, { Component } from 'react';
import {
     AppRegistry,
     Platform,
     PermissionsAndroid, // for checking if certain android permissions are enabled
     StyleSheet,
     Text,
     View,
     NativeEventEmitter, // for emitting events for the BLE manager
     NativeModules, // for getting an instance of the BLE manager module
     Button,
     ToastAndroid, // for showing notification if there's a new attendee
     FlatList, // for creating lists
     Alert
} from 'react-native';
import { BleManager, Characteristic } from 'react-native-ble-plx';
import { stringToBytes } from 'convert-string'; // for converting string to byte array
import RandomId from 'random-id'; // for generating random user ID
import bytesCounter from 'bytes-counter'; // for getting the number of bytes in a string
import Spinner from 'react-native-spinkit'; // for showing a spinner when loading something
import { Buffer } from 'buffer';
//import Prompt from 'react-native-prompt'; // for showing an input prompt

const BleManagerModule = NativeModules.BleManager;
const bleManagerEmitter = new NativeEventEmitter(BleManagerModule);

export default class App extends Component {

  constructor() {
    super();
    this.manager = new BleManager()
    this.state = {
      is_scanning: false, // whether the app is currently scanning for peripherals or not
      peripherals: null, // the peripherals detected
      connected_peripheral: null, // the currently connected peripheral
      info: "",
      values: {},
    }
    
    this.prefixUUID = "33134D"
    this.suffixUUID = "-24FC-4193-BD70-48980231B857"

    // this.prefixUUID = "164C59CB"
    // this.suffixUUID = "-A528-4A85-8E31-0FFA617DCD44"

    // this.UUID = "164C59CB-A528-4A85-8E31-0FFA617DCD44"
    // 33134DA3-24FC-4193-BD70-48980231B857
    this.sensors = {
      0: "Temperature",
      1: "Accelerometer",
      2: "Humidity",
      3: "Magnetometer",
      4: "Barometer",
      5: "Gyroscope"
    }
  }

  

  serviceUUID(num) {
    //return this.prefixUUID + "A3" + this.suffixUUID
    return "DFB0"
    // return "FFE0"
  }

  notifyUUID(num) {
    //return this.prefixUUID + "A3" + this.suffixUUID
    return "DFB1"
  }

  writeUUID(num) {
    //return this.prefixUUID + "A3" + this.suffixUUID
    // return "FFE1"
    return "DFB1"
  }

  info(message) {
    this.setState({info: message})
  }

  error(message) {
    this.setState({info: "ERROR: " + message})
  }

  updateValue(key, value) {
    this.setState({values: {...this.state.values, [key]: value}})
  }


  componentWillMount() {
    const subscription = this.manager.onStateChange((state) => {
      if (state === 'PoweredOn') {
          this.scanAndConnect();
          subscription.remove();
      }
    }, true);

   /*  if (Platform.OS === 'ios') {
      this.manager.onStateChange((state) => {
        if (state === 'PoweredOn') this.scanAndConnect()
      })
    } else {
      this.scanAndConnect()
    } */

    bleManagerEmitter.addListener('BleManagerDiscoverPeripheral', (peripheral) => {

      var peripherals = this.peripherals; // get the peripherals
      // check if the peripheral already exists
      var el = peripherals.filter((el) => {
        return el.id === peripheral.id;
      });

      if(!el.length){
        peripherals.push({
          id: peripheral.id, // mac address of the peripheral
          name: peripheral.name // descriptive name given to the peripheral
        });
        this.peripherals = peripherals; // update the array of peripherals
      }
    });
  }

  scanAndConnect() {
    this.manager.startDeviceScan(null, null, (error, device) => {
      this.info("Scanning...")
      console.log(device)
     
      if (device.name === 'Drey') {
        this.info("Connecting to Bluetooth Device")
        this.manager.stopDeviceScan()
        device.connect()
          .then((device) => {
            this.info("Discovering services and characteristics")
            return device.discoverAllServicesAndCharacteristics()
          })
          .then((device) => {
            this.info("Setting notifications")
            return this.setupNotifications(device)
          })
          .then(() => {
            this.info("Listening...")
          }, (error) => {
            this.error(error.message)
          })
      }
    });
  }


  /*
  Implementation: promise
  Enables notifications for specified sensor by writing value of 0x01 -> configuration characteristic
  Upon completion of write characteristics: Start listening for values
  */

  async setupNotifications(device) {
    for (const id in this.sensors) {
      const service = this.serviceUUID("DFB0")
      const characteristicW = this.writeUUID("DFB1")
      const characteristicN = this.notifyUUID("DFB1")

      /* const service = this.serviceUUID("FFE0")
      const characteristicW = this.writeUUID("FFE1")
      const characteristicN = this.notifyUUID("FFE1") */

      const characteristic = await device.writeCharacteristicWithResponseForService(
        //service, characteristicW, "Qk2e6gAAAAAAAD4AAAAoAAAAIAMAAFgCAAABAAEAAAAAAGDqAADpJAAA6SQAAAAAAAAAAAAAAAAAAP///wD//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////+AAAAAAAAAAAAf/AAAAAP//+AAAAAf/AAAAAAAAB/////gA/////wAf////////AAAH////////4AAA///4AP/gB/////gA///4AP//+AAAAAf////////////////////////gAAAAAAAAAAAH/wAAAAD///gAAAAH/wAAAAAAAAf////4AP////8AH////////wAAB////////+AAAP//+AD/4Af////4AP//+AD///gAAAAH////////////////////////4AAAAAAAAAAAB/8AAAAA///4AAAAB/8AAAAAAAAH////+AD/////AB////////8AAAf////////gAAD///gA/+AH////+AD///gA///4AAAAB////////////////////////+AAAAAAAAAAAAf/AAAAAP//+AAAAAf/AAAAAAAAB/////gA/////wAf////////AAAH////////4AAA///4AP/gB/////gA///4AP//+AAAAAf////////////////////////gAAAAAAAAAAAH/wAAAAD///gAAAAH/wAAAAAAAAf////4AP////8AH////////wAAB////////+AAAP//+AD/4Af////4AP//+AD///gAAAAH////////////////////////4AAAAAAAAAAAB/8AAAAA///4AAAAB/8AAAAAAAAH////+AD/////AB////////8AAAf////////gAAD///gA/+AH////+AD///gA///4AAAAB////////////////////////+AAAAAAAAAAAAf/AAAAAP//+AAAAAf/AAAAAAAAB/////gA/////wAf////////AAAH////////4AAA///4AP/gB/////gA///4AP//+AAAAAf////////////////////////gAAAAAAAAAAAH/wAAAAD///gAAAAH/wAAAAAAAAf////4AP////8AH////////wAAB////////+AAAP//+AD/4Af////4AP//+AD///gAAAAH////////////////////////4Af////////gB/8AH/gAAB/4AAAAAAD/4Af/AAAAAAAAAAD/4AAA/+AAAAAAAAD///gAAAAAAP/gB/8AH/gA///4AAAAB/8AAAf//+AH///gB////////////////////////+AH////////4Af/AB/4AAAf+AAAAAAA/+AH/wAAAAAAAAAA/+AAAP/gAAAAAAAA///4AAAAAAD/4Af/AB/4AP//+AAAAAf/AAAH///gB///4Af////////////////////////gB////////+AH/wAf+AAAH/gAAAAAAP/gB/8AAAAAAAAAAP/gAAD/4AAAAAAAAP//+AAAAAAA/+AH/wAf+AD///gAAAAH/wAAB///4Af//+AH////////////////////////4Af////////gB/8AH/gAAB/4AAAAAAD/4Af/AAAAAAAAAAD/4AAA/+AAAAAAAAD///gAAAAAAP/gB/8AH/gA///4AAAAB/8AAAf//+AH///gB////////////////////////+AH////////4Af/AB/4AAAf+AAAAAAA/+AH/wAAAAAAAAAA/+AAAP/gAAAAAAAA///4AAAAAAD/4Af/AB/4AP//+AAAAAf/AAAH///gB///4Af////////////////////////gB////////+AH/wAf+AAAH/gAAAAAAP/gB/8AAAAAAAAAAP/gAAD/4AAAAAAAAP//+AAAAAAA/+AH/wAf+AD///gAAAAH/wAAB///4Af//+AH////////////////////////4Af////////gB/8AH/gAAB/4AAAAAAD/4Af/AAAAAAAAAAD/4AAA/+AAAAAAAAD///gAAAAAAP/gB/8AH/gA///4AAAAB/8AAAf//+AH///gB////////////////////////+AH////////4Af/AB/4AAAf+AAAAAAA/+AH/wAAAAAAAAAA/+AAAP/gAAAAAAAA///4AAAAAAD/4Af/AB/4AP//+AAAAAf/AAAH///gB///4Af////////////////////////gB/8AAAAA/+AH/wAAAAD///gA///////gAAAAAAAAAAAAAP/gAAD/////AAAAAP/gB/8AAAf//////wAf+AD/4AAAAB//////+AD/4Af//+AH////////////////////////4Af/AAAAAP/gB/8AAAAA///4AP//////4AAAAAAAAAAAAAD/4AAA/////wAAAAD/4Af
        ///AAAH//////8AH/gA/+AAAAAf//////gA/+AH///gB//////////////
        service, characteristicW, "dGVzdB== ", 
      )

      device.monitorCharacteristicForService(service, characteristicN, (error, characteristic) => {
        if (error) {
          this.error(error.message)
          return
        }
        this.updateValue(characteristic.uuid, characteristic.value)
      })
    }
  }
  
  scanDevice(){
    bleManagerEmitter.addListener(
    'BleManagerStopScan',
    () => {
      console.log('scan stopped');
      if(this.peripherals.length == 0){
        Alert.alert('Nothing found', "Sorry, no peripherals were found");
      }
      this.setState({
        is_scanning: false,
        peripherals: this.peripherals
      });  
    }
  );
}

  render() {
    return (
      <View style={styles.container}> 
        <Text>{this.state.info}</Text>
        {Object.keys(this.sensors).map((key) => {
          return 
            <Text key={key}>
              {this.sensors[key] + ": " + (this.state.values[this.notifyUUID(key)] || "-")}
            </Text>
        })}
      </View>
    )
  }
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    backgroundColor: '#F5FCFF',
  },
  welcome: {
    fontSize: 20,
    textAlign: 'center',
    margin: 10,
  },
  instructions: {
    textAlign: 'center',
    color: '#333333',
    marginBottom: 5,
  },
});
